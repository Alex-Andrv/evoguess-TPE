from algorithm.impl import Elitism
from algorithm.module.crossover import TwoPoint
from algorithm.module.mutation import Doer
from algorithm.module.selection import Roulette
from core.impl import Optimize
from core.module.comparator import MinValueMaxSize
from core.module.limitation import WallTime
from core.module.sampling import Const
from core.module.space import SearchSet
from executor.impl import ProcessExecutor
from function.impl import RhoFunction
from function.module.measure import Propagations
from function.module.solver.impl import Glucose3
from instance.impl import Instance
from instance.module.encoding import CNF
from instance.module.variables import Indexes
from output.impl import OptimizeLogger
from typings.work_path import WorkPath

if __name__ == '__main__':
    root_path = WorkPath('examples')
    data_path = root_path.to_path('data')
    cnf_file = data_path.to_file('bubble_vs_pancake_10_4.cnf')

    logs_path = root_path.to_path('logs', 'bubble_vs_pancake_10_4')
    solution = Optimize(
        space=SearchSet(
            by_mask=[],
            variables=Indexes([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 49, 50, 57, 68, 73, 74, 75, 76, 85, 86, 104, 105, 106, 107, 108, 109, 110, 111, 112, 121, 122, 139, 140, 148, 158, 159, 160, 161, 162, 163, 164, 165, 176, 180, 184, 193, 194, 212, 213, 214, 215, 216, 217, 218, 219, 220, 230, 231, 232, 233, 234, 235, 236, 237, 238, 247, 248, 253, 254, 255, 256, 265, 266, 270, 284, 285, 286, 287, 288, 289, 290, 291, 292, 301, 302, 307, 308, 309, 310, 319, 320, 324, 328, 338, 339, 340, 341, 342, 355, 356, 374, 375, 376, 377, 378, 379, 380, 381, 382, 392, 393, 394, 395, 397, 398, 399, 410, 414, 415, 416, 417, 418, 427, 428, 446, 447, 448, 449, 450, 451, 452, 453, 454, 463, 464, 465, 466, 467, 468, 482, 486, 487, 488, 489, 500, 504, 505, 506, 507, 508, 517, 518, 536, 537, 538, 539, 540, 541, 542, 543, 544, 553, 554, 559, 560, 561, 562, 571, 572, 573, 574, 575, 576, 590, 591, 592, 593, 595, 596, 597, 608, 609, 610, 611, 612, 613, 614, 615, 616, 625, 626, 631, 632, 633, 634, 643, 644, 649, 650, 651, 652, 661, 662, 663, 664, 665, 666, 680, 684, 685, 686, 687, 688, 697, 698, 702, 716, 717, 718, 719, 720, 721, 722, 723, 724, 733, 734, 735, 736, 737, 738, 752, 753, 754, 755, 756, 757, 758, 759, 769, 770, 774, 775, 776, 777, 778, 787, 788, 789, 790, 791, 792, 806, 807, 808, 809, 810, 811, 812, 813, 814, 823, 824, 825, 826, 827, 828, 841, 842, 859, 860, 883, 897, 941, 944, 955, 959, 970, 973, 999, 1015, 1032, 1037, 1048, 1052, 1131, 1147, 1164, 1167, 1169, 1180, 1197, 1263, 1279, 1282, 1296, 1300, 1301, 1312, 1315, 1317, 1329, 1345, 1349, 1395, 1398, 1411, 1415, 1416, 1428, 1431, 1444, 1449, 1461, 1477, 1481, 1494, 1497, 1527, 1545, 1564, 1582, 1601, 1607, 1619, 1622, 1638, 1656, 1660, 1661, 1712, 1730, 1749, 1752, 1767, 1773, 1786, 1804, 1810, 1823, 1826, 1827, 1828, 1841, 1846, 1847, 1860, 1863, 1864, 1887, 1899, 1914, 1927, 1928, 1929, 1930, 1933, 1934, 1935, 1936, 1937, 1938, 1939, 1940, 1941, 1942, 1943, 1944, 1945, 1946, 1947, 1948, 1949, 1955, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2010, 2045, 2082, 2084, 2085, 2086, 2087, 2092, 2093, 2094, 2095, 2096, 2097, 2098, 2099, 2100, 2101, 2102, 2103, 2104, 2105, 2106, 2107, 2108, 2109, 2110, 2111, 2112, 2113, 2114, 2115, 2116, 2117, 2118, 2119, 2120, 2121, 2122, 2123, 2132, 2133, 2156, 2170, 2214, 2217, 2228, 2232, 2243, 2246, 2272, 2288, 2305, 2310, 2321, 2325, 2404, 2420, 2437, 2440, 2441, 2453, 2458, 2470, 2474, 2519, 2536, 2540, 2552, 2555, 2569, 2573, 2585, 2590, 2602, 2618, 2621, 2622, 2668, 2673, 2684, 2688, 2701, 2704, 2717, 2734, 2739, 2750, 2754, 2767, 2770, 2800, 2818, 2837, 2855, 2874, 2880, 2892, 2897, 2911, 2929, 2935, 2956, 2968, 2984, 2997, 2998, 2999, 3000, 3003, 3004, 3005, 3006, 3007, 3008, 3009, 3010, 3011, 3012, 3013, 3014, 3015, 3016, 3017, 3018, 3019, 3024, 3051, 3081, 3110, 3111, 3112, 3113, 3117, 3118, 3119, 3120, 3121, 3122, 3123, 3124, 3125, 3126, 3127, 3128, 3129, 3130, 3131, 3132, 3133, 3134, 3135, 3136, 3137, 3138, 3139, 3140, 3141, 3142, 3143, 3144, 3145, 3146, 3147, 3148, 3161, 3162, 3185, 3199, 3243, 3246, 3257, 3261, 3272, 3275, 3301, 3317, 3334, 3339, 3350, 3354, 3433, 3436, 3449, 3466, 3482, 3499, 3502, 3504, 3565, 3570, 3581, 3584, 3585, 3598, 3603, 3614, 3631, 3647, 3650, 3651, 3697, 3702, 3713, 3717, 3730, 3733, 3746, 3751, 3763, 3779, 3796, 3819, 3830, 3844, 3857, 3858, 3859, 3860, 3862, 3863, 3864, 3865, 3866, 3867, 3868, 3869, 3870, 3871, 3872, 3873, 3874, 3875, 3876, 3877, 3878, 3883, 3908, 3937, 3939, 3940, 3941, 3942, 3947, 3948, 3949, 3950, 3951, 3952, 3953, 3954, 3955, 3956, 3957, 3958, 3959, 3960, 3961, 3962, 3963, 3964, 3965, 3966, 3967, 3968, 3969, 3970, 3979, 3980, 4003, 4017, 4061, 4064, 4075, 4079, 4090, 4093, 4119, 4135, 4152, 4157, 4168, 4172, 4235, 4238, 4251, 4256, 4268, 4272, 4284, 4289, 4301, 4351, 4355, 4367, 4370, 4372, 4384, 4400, 4405, 4413, 4417, 4421, 4433, 4436, 4457, 4468, 4481, 4500, 4504, 4509, 4510, 4511, 4512, 4521, 4542, 4543, 4544, 4545, 4546, 4548, 4549, 4550, 4551, 4552, 4553, 4554, 4556, 4557, 4558, 4559, 4560, 4561, 4562, 4563, 4564, 4565, 4566, 4567, 4568, 4569, 4570, 4571, 4584, 4585, 4608, 4622, 4626, 4666, 4680, 4684, 4695, 4698, 4724, 4740, 4757, 4762, 4773, 4777, 4823, 4826, 4839, 4856, 4872, 4877, 4889, 4912, 4923, 4924, 4925, 4926, 4927, 4937, 4955, 4976, 4978, 4979, 4980, 4981, 4982, 4983, 4984, 4985, 4986, 4987, 4988, 4989, 4990, 4991, 4992, 4993, 4994, 4995, 4996, 4997, 4998, 4999, 5000, 5001, 5010, 5011, 5034, 5048, 5092, 5095, 5106, 5110, 5121, 5124, 5150, 5166, 5183, 5199, 5204, 5222, 5234, 5248, 5261, 5262, 5263, 5264, 5268, 5269, 5270, 5271, 5272, 5273, 5274, 5275, 5276, 5277, 5278, 5279, 5280, 5281, 5282, 5283, 5296, 5297, 5320, 5334, 5338, 5378, 5392, 5407, 5449, 5451, 5452, 5453, 5454, 5455, 5456, 5457, 5458, 5459, 5460, 5461, 5462, 5463, 5464, 5465, 5466, 5471, 5475, 5499, 5513, 5515, 5519, 5533, 5540, 5541, 5547, 5548, 5549, 5550, 5551, 5566, 5581, 5582, 5585, 5586, 5592, 5595, 5600, 5604, 5608, 5612, 5616, 5630, 5631, 5632, 5633, 5634, 5635])),
        executor=ProcessExecutor(max_workers=4),
        sampling=Const(size=1024, split_into=256),
        instance=Instance(
            encoding=CNF(from_file=cnf_file)
        ),
        function=RhoFunction(
            penalty_power=2 ** 10,
            measure=Propagations(),
            solver=Glucose3()
        ),
        algorithm=Elitism(
            elites_count=5,
            population_size=10,
            mutation=Doer(),
            crossover=TwoPoint(),
            selection=Roulette(),
            min_update_size=10
        ),
        comparator=MinValueMaxSize(),
        logger=OptimizeLogger(logs_path),
        limitation=WallTime(from_string='09:30:00'),
    ).launch()
    for point in solution:
        print(point)

# [344 500 888 891 1058 1581 1773 2108 2286 3153 3530 3594 3756 3771 4001 4227 4261](17) by 224256
# [245 344 500 888 891 1058 1581 1773 2108 3153 3530 3594 3756 3771 4001 4227 4261](17) by 224256
# [344 500 888 891 1058 1581 1773 2108 3153 3530 3594 3720 3756 3771 4001 4227 4261](17) by 285184
# [344 500 888 891 1058 1581 1773 2108 2286 3153 3530 3594 3756 3771 4001 4227 4230 4261](18) by 375808
# [245 344 500 888 891 1058 1581 1773 2108 3046 3153 3530 3594 3756 3771 4001 4227 4261](18) by 381952
# [344 500 888 891 1058 1240 1581 1773 2108 2286 3153 3530 3594 3756 3771 4001 4227 4261 5244 5287 5854](21) by inf
# [344 500 888 891 1058 1581 1773 1833 2108 2286 3153 3530 3594 3756 3771 4001 4227 4261 4553 5244 5287](21) by inf
# [60 137 344 500 888 891 1058 1581 1773 2108 2286 3153 3530 3594 3756 3771 4001 4025 4227 4261](20) by inf